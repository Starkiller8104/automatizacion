# -*- coding: utf-8 -*-
"""Untitled16.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/18xSjlYum0k2ndcM1f52KaFCunTC81E2U
"""

# app.py
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Indicadores (Ãºltimos 6 dÃ­as con tu layout) + Noticias + (opcional) GrÃ¡ficos y Datos crudos.
# Fixes: fechas naive (sin tz), charts seguros, noticias con fallback.
# Tokens incluidos (Banxico/INEGI).
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

import io
import re
import time
import html
from datetime import datetime, timedelta
from email.utils import parsedate_to_datetime
import pytz
import requests
from requests.adapters import HTTPAdapter, Retry
import streamlit as st
from openpyxl import Workbook
from openpyxl.styles import Alignment, Font
from openpyxl.utils import get_column_letter
from openpyxl.chart import LineChart, Reference
from openpyxl.chart.axis import DateAxis

# =========================
#  TOKENS
# =========================
BANXICO_TOKEN = "677aaedf11d11712aa2ccf73da4d77b6b785474eaeb2e092f6bad31b29de6609"
INEGI_TOKEN   = "9886fe68-e51f-c345-0b8f-adb99da1a1fd"
FRED_TOKEN    = ""  # opcional

TZ_MX = pytz.timezone("America/Mexico_City")

# =========================
#  SERIES SIE
# =========================
SIE_SERIES = {
    "USD_FIX":   "SF43718",
    "EUR_FIX":   "SF46410",
    "JPY_FIX":   "SF46406",
    "TIIE_OBJ":  "",         # si me das el ID real lo conecto
    "TIIE_28":   "SF60653",
    "TIIE_91":   "",         # id real pendiente
    "TIIE_182":  "",         # id real pendiente
    "CETES_28":  "SF43936",
    "CETES_91":  "",         # id real pendiente
    "CETES_182": "",         # id real pendiente
    "CETES_364": "",         # id real pendiente
    "UDIS":      "SP68257",
}

# =========================
#  Utilidades
# =========================
def http_session(timeout=15):
    s = requests.Session()
    retries = Retry(total=3, backoff_factor=0.8,
                    status_forcelist=[429, 500, 502, 503, 504],
                    allowed_methods=frozenset(["GET", "POST"]))
    s.mount("https://", HTTPAdapter(max_retries=retries))
    s.request_timeout = timeout
    return s

def now_ts():
    return datetime.now(TZ_MX).strftime("%Y-%m-%d %H:%M:%S")

def today_cdmx():
    return datetime.now(TZ_MX).date()

def try_float(x):
    try:
        return float(str(x).replace(",", ""))
    except:
        return None

def parse_any_date(s: str):
    """Devuelve datetime *naive* (sin tz) para Excel."""
    if not s:
        return None
    s = str(s)
    # fechas tipo 'YYYY-MM-DD' o 'DD/MM/YYYY'
    for fmt in ("%Y-%m-%d", "%d/%m/%Y"):
        try:
            dt = datetime.strptime(s, fmt)
            return dt  # naive
        except:
            pass
    # pubDate RSS u otros con tz -> convertir a CDMX y quitar tz
    try:
        dt = parsedate_to_datetime(s)
        if dt.tzinfo is not None:
            dt = dt.astimezone(TZ_MX).replace(tzinfo=None)
        return dt
    except:
        return None

def ensure_naive(dt: datetime | None):
    if dt is None: return None
    if dt.tzinfo is not None:
        return dt.astimezone(TZ_MX).replace(tzinfo=None)
    return dt

def _check_tokens():
    missing = []
    if not BANXICO_TOKEN.strip(): missing.append("BANXICO_TOKEN")
    if not INEGI_TOKEN.strip():   missing.append("INEGI_TOKEN")
    if missing:
        st.error("Faltan tokens: " + ", ".join(missing))
        st.stop()

# =========================
#  Banxico SIE
# =========================
@st.cache_data(ttl=60*30)
def sie_opportuno(series_id):
    url = f"https://www.banxico.org.mx/SieAPIRest/service/v1/series/{series_id}/datos/oportuno"
    headers = {"Bmx-Token": BANXICO_TOKEN}
    r = http_session().get(url, headers=headers, timeout=15)
    r.raise_for_status()
    return r.json()

def sie_latest(series_id):
    try:
        data = sie_opportuno(series_id)
        serie = data["bmx"]["series"][0]["datos"]
        if not serie: return None, None
        last = serie[-1]
        return last["fecha"], try_float(last["dato"])
    except:
        return None, None

@st.cache_data(ttl=60*30)
def sie_range(series_id: str, start_iso: str, end_iso: str):
    url = f"https://www.banxico.org.mx/SieAPIRest/service/v1/series/{series_id}/datos/{start_iso}/{end_iso}"
    headers = {"Bmx-Token": BANXICO_TOKEN}
    r = http_session(20).get(url, headers=headers, timeout=20)
    r.raise_for_status()
    j = r.json()
    series = j.get("bmx", {}).get("series", [])
    if not series:
        return []
    return series[0].get("datos", []) or []

def sie_last_n(series_id: str, n: int = 6):
    end = today_cdmx()
    start = end - timedelta(days=2*365)
    obs = sie_range(series_id, start.isoformat(), end.isoformat())
    vals = []
    for o in obs:
        f = o.get("fecha")
        v = try_float(o.get("dato"))
        if f and (v is not None):
            vals.append((f, v))
    if not vals:
        return []
    vals.sort(key=lambda x: parse_any_date(x[0]) or datetime.utcnow())
    return vals[-n:]

def rolling_movex_for_last6(window:int=20):
    end = today_cdmx()
    start = end - timedelta(days=365)
    obs = sie_range(SIE_SERIES["USD_FIX"], start.isoformat(), end.isoformat())
    series = [try_float(o.get("dato")) for o in obs if try_float(o.get("dato")) is not None]
    if not series:
        return [None]*6
    out = []
    for k in range(6, 0, -1):
        idx = len(series) - k
        sub = series[max(0, idx-window+1): idx+1]
        out.append(sum(sub)/len(sub) if sub else None)
    return out

# =========================
#  INEGI UMA
# =========================
@st.cache_data(ttl=60*60)
def get_uma(inegi_token: str):
    base = "https://www.inegi.org.mx/app/api/indicadores/desarrolladores/jsonxml/INDICATOR"
    ids = "620706,620707,620708"
    url = f"{base}/{ids}/es/00/true/BISE/2.0/{inegi_token}?type=json"
    try:
        r = http_session(20).get(url, timeout=20)
        if r.status_code in (401,403) or r.status_code != 200:
            return {"fecha": str(today_cdmx()), "diaria": None, "mensual": None, "anual": None}
        data = r.json()
        series = data.get("Series", [])
        if not series or any("OBSERVATIONS" not in s for s in series):
            return {"fecha": str(today_cdmx()), "diaria": None, "mensual": None, "anual": None}
        diaria_obs  = series[0]["OBSERVATIONS"][-1]
        mensual_obs = series[1]["OBSERVATIONS"][-1] if series[1]["OBSERVATIONS"] else None
        anual_obs   = series[2]["OBSERVATIONS"][-1] if series[2]["OBSERVATIONS"] else None
        fecha   = diaria_obs.get("TIME_PERIOD") or str(today_cdmx())
        diaria  = try_float(diaria_obs.get("OBS_VALUE"))
        mensual = try_float(mensual_obs.get("OBS_VALUE")) if mensual_obs else None
        anual   = try_float(anual_obs.get("OBS_VALUE")) if anual_obs else None
        if diaria is not None:
            if mensual is None: mensual = diaria * 30.4
            if anual   is None: anual   = (mensual or (diaria * 30.4)) * 12
        return {"fecha": fecha, "diaria": diaria, "mensual": mensual, "anual": anual}
    except:
        return {"fecha": str(today_cdmx()), "diaria": None, "mensual": None, "anual": None}

# =========================
#  FRED (opc)
# =========================
@st.cache_data(ttl=60*30)
def fred_observations(series_id: str, start_date: str = None, end_date: str = None):
    base = "https://api.stlouisfed.org/fred/series/observations"
    params = {"series_id": series_id, "file_type": "json"}
    if FRED_TOKEN.strip(): params["api_key"] = FRED_TOKEN.strip()
    if start_date: params["observation_start"] = start_date
    if end_date:   params["observation_end"]   = end_date
    r = http_session(20).get(base, params=params, timeout=20)
    r.raise_for_status()
    return r.json().get("observations", [])

def fred_last_n(series_id: str, n: int = 12):
    try:
        end = datetime.utcnow().date()
        start = (end - timedelta(days=5*365)).isoformat()
        obs = fred_observations(series_id, start_date=start, end_date=end.isoformat())
        out = [(o["date"], try_float(o["value"])) for o in obs if o.get("value") not in (".", None)]
        return out[-n:] if out else []
    except:
        return []

def fred_cpi_yoy_series(n: int = 12):
    try:
        end = datetime.utcnow().date()
        start = (end - timedelta(days=6*365)).isoformat()
        obs = fred_observations("CPIAUCSL", start_date=start, end_date=end.isoformat())
        obs = [(o["date"], try_float(o["value"])) for o in obs if o.get("value") not in (".", None)]
        if len(obs) < 13: return []
        yoy = []
        for i in range(12, len(obs)):
            f_now, v_now = obs[i]
            f_prev, v_prev = obs[i-12]
            if v_now is None or not v_prev: continue
            yoy.append((f_now, (v_now / v_prev - 1) * 100.0))
        return yoy[-n:] if yoy else []
    except:
        return []

# =========================
#  Noticias (RSS)
# =========================
RSS_FEEDS = [
    "https://feeds.reuters.com/reuters/businessNews",
    "https://feeds.reuters.com/reuters/marketsNews",
    "https://finance.yahoo.com/news/rssindex",
]

def _strip_html(s: str) -> str:
    if not s:
        return ""
    s = html.unescape(s)
    s = re.sub(r"<[^>]+>", "", s)
    return s.replace("\xa0", " ").strip()

@st.cache_data(ttl=60*15)
def fetch_financial_news(limit_per_feed=8, total_limit=20):
    items = []
    s = http_session(15)
    for url in RSS_FEEDS:
        try:
            r = s.get(url, timeout=s.request_timeout)
            r.raise_for_status()
            from xml.etree import ElementTree as ET
            root = ET.fromstring(r.content)
            for item in root.findall(".//item")[:limit_per_feed]:
                title = _strip_html(item.findtext("title") or "")
                link  = (item.findtext("link") or "").strip()
                desc  = _strip_html(item.findtext("description") or "")
                pub   = item.findtext("pubDate") or ""
                dt    = parse_any_date(pub) or datetime.utcnow()
                dt    = ensure_naive(dt)
                source = re.sub(r"^https?://(www\.)?([^/]+)/?.*$", r"\2", link) if link else "rss"
                items.append({"dt": dt, "title": title, "link": link, "summary": desc, "source": source})
        except Exception:
            continue
    items.sort(key=lambda x: x["dt"], reverse=True)
    seen = set(); out = []
    for it in items:
        key = it["title"][:120]
        if key in seen: 
            continue
        seen.add(key); out.append(it)
        if len(out) >= total_limit: break
    return out

# =========================
#  Excel helpers
# =========================
def set_cell(ws, cell, value, bold=False):
    ws[cell].value = value
    if bold: ws[cell].font = Font(bold=True)

def autosize(ws, min_col=1, max_col=8):
    for col in range(min_col, max_col+1):
        letter = get_column_letter(col)
        max_len = 0
        for cell in ws[letter]:
            if cell.value is None: continue
            max_len = max(max_len, len(str(cell.value)))
        ws.column_dimensions[letter].width = min(max_len + 2, 60)

def write_row_values(ws, row_idx: int, values6):
    for j, v in enumerate(values6, start=2):  # columnas B..G
        ws.cell(row=row_idx, column=j, value=v)

# â”€â”€ Hoja Indicadores (layout)
def crear_hoja_indicadores_layout(valores: dict, movex6, compra6, venta6):
    wb = Workbook()
    ws = wb.active
    ws.title = "Indicadores"

    set_cell(ws, "A2", "Fecha:", bold=True)
    ws["B2"], ws["C2"], ws["D2"], ws["E2"], ws["F2"], ws["G2"] = "DÃ­a 1", "DÃ­a 2", "DÃ­a 3", "DÃ­a 4", "DÃ­a 5", "DÃ­a actual"

    set_cell(ws, "A4", "TIPOS DE CAMBIO:", bold=True)
    set_cell(ws, "A6", "DÃ“LAR AMERICANO.", bold=True)
    set_cell(ws, "A7", "DÃ³lar/Pesos:")
    set_cell(ws, "A8", "MOVEX:")
    set_cell(ws, "A9", "Compra:")
    set_cell(ws, "A10","Venta:")

    set_cell(ws, "A12","YEN JAPONÃ‰S.", bold=True)
    set_cell(ws, "A13","Yen JaponÃ©s/Peso:")
    set_cell(ws, "A14","DÃ³lar/Yen JaponÃ©s:")

    set_cell(ws, "A16","EURO.", bold=True)
    set_cell(ws, "A17","Euro/Peso:")
    set_cell(ws, "A18","Euro/DÃ³lar:")

    set_cell(ws, "A20","UDIS:", bold=True)
    set_cell(ws, "A22","UDIS: ")

    set_cell(ws, "A24","TASAS TIIE:", bold=True)
    set_cell(ws, "A26","TIIE objetivo:")
    set_cell(ws, "A27","TIIE 28 DÃ­as:")
    set_cell(ws, "A28","TIIE 91 DÃ­as:")
    set_cell(ws, "A29","TIIE 182 DÃ­as:")

    set_cell(ws, "A31","CETES:", bold=True)
    set_cell(ws, "A33","CETES 28 DÃ­as:")
    set_cell(ws, "A34","CETES 91 DÃ­as:")
    set_cell(ws, "A35","Cetes 182 DÃ­as:")
    set_cell(ws, "A36","Cetes 364 DÃ­as:")

    set_cell(ws, "A38","UMA:", bold=True)
    set_cell(ws, "A40","Diario:")
    set_cell(ws, "A41","Mensual:")
    set_cell(ws, "A42","Anual:")

    write_row_values(ws, 7,  valores["usd6"])
    write_row_values(ws, 8,  movex6)
    write_row_values(ws, 9,  compra6)
    write_row_values(ws, 10, venta6)

    write_row_values(ws, 13, valores["jpy6"])
    write_row_values(ws, 14, valores["usdjpy6"])

    write_row_values(ws, 17, valores["eur6"])
    write_row_values(ws, 18, valores["eurusd6"])

    write_row_values(ws, 22, valores["udis6"])

    write_row_values(ws, 26, valores["tiie_obj6"])
    write_row_values(ws, 27, valores["tiie28_6"])
    write_row_values(ws, 28, valores["tiie91_6"])
    write_row_values(ws, 29, valores["tiie182_6"])

    write_row_values(ws, 33, valores["cetes28_6"])
    write_row_values(ws, 34, valores["cetes91_6"])
    write_row_values(ws, 35, valores["cetes182_6"])
    write_row_values(ws, 36, valores["cetes364_6"])

    write_row_values(ws, 40, valores["uma_diaria6"])
    write_row_values(ws, 41, valores["uma_mensual6"])
    write_row_values(ws, 42, valores["uma_anual6"])

    autosize(ws, 1, 7)
    return wb

# â”€â”€ Hoja Noticias
def add_news_sheet(wb, news_items):
    ws2 = wb.create_sheet("Noticias")
    set_cell(ws2, "A1", "Resumen de noticias financieras", bold=True)
    set_cell(ws2, "A2", f"Generado: {now_ts()} (CDMX)")
    headers = ["Fecha", "Fuente", "TÃ­tulo", "Resumen", "Link"]
    for col, h in enumerate(headers, start=1):
        c = ws2.cell(row=4, column=col, value=h); c.font = Font(bold=True)
    r = 5
    if not news_items:
        ws2.cell(row=r, column=1, value="Sin datos"); ws2.cell(row=r, column=3, value="No se pudieron descargar noticias (ver conexiÃ³n/red).")
        autosize(ws2, 1, 5); return
    for it in news_items:
        dt = ensure_naive(it["dt"]) or datetime.now()  # siempre naive
        ws2.cell(row=r, column=1, value=dt); ws2.cell(row=r, column=1).number_format = "yyyy-mm-dd hh:mm"
        ws2.cell(row=r, column=2, value=it["source"])
        ws2.cell(row=r, column=3, value=it["title"])
        ws2.cell(row=r, column=4, value=(it["summary"][:400] + ("..." if len(it["summary"])>400 else "")))
        ws2.cell(row=r, column=5, value=it["link"])
        ws2.cell(row=r, column=4).alignment = Alignment(wrap_text=True, vertical="top")
        r += 1
    autosize(ws2, 1, 5)

# â”€â”€ GrÃ¡ficos + Datos crudos
def write_series_table(ws, start_row: int, start_col: int, title: str, series):
    # filtrar filas sin valor
    series = [(f, v) for (f, v) in series if v is not None]
    r, c = start_row, start_col
    ws.cell(row=r, column=c, value=title).font = Font(bold=True); r += 1
    ws.cell(row=r, column=c,   value="Fecha").font = Font(bold=True)
    ws.cell(row=r, column=c+1, value="Valor").font = Font(bold=True); r += 1
    for (f, v) in series:
        dt = parse_any_date(f) or datetime.utcnow()
        ws.cell(row=r, column=c,   value=dt); ws.cell(row=r, column=c).number_format="yyyy-mm-dd"
        ws.cell(row=r, column=c+1, value=v)
        r += 1
    return (start_row+2, c, r-1, c+1)

def add_line_chart(ws, title: str, data_range, place_at=("H", 2)):
    (r0, c0, r1, c1) = data_range
    if r1 <= r0:  # necesita al menos 2 filas de datos
        return
    chart = LineChart()
    chart.title = title
    chart.style = 2
    chart.y_axis.title = "Valor"
    chart.x_axis = DateAxis(); chart.x_axis.number_format = "yyyy-mm-dd"; chart.x_axis.title = "Fecha"
    data = Reference(ws, min_col=c1, min_row=r0, max_col=c1, max_row=r1)
    cats = Reference(ws, min_col=c0, min_row=r0, max_row=r1)
    chart.add_data(data, titles_from_data=False)
    chart.set_categories(cats)
    ws.add_chart(chart, f"{place_at[0]}{place_at[1]}")

def add_raw_sheet(wb, raw_data: dict):
    ws = wb.create_sheet("Datos crudos")
    ws.cell(row=1, column=1, value="Serie").font = Font(bold=True)
    ws.cell(row=1, column=2, value="Fecha").font = Font(bold=True)
    ws.cell(row=1, column=3, value="Valor").font = Font(bold=True)
    r = 2
    for name, serie in raw_data.items():
        for (f, v) in serie:
            if v is None: continue
            dt = parse_any_date(f) or datetime.utcnow()
            ws.cell(row=r, column=1, value=name)
            ws.cell(row=r, column=2, value=dt); ws.cell(row=r, column=2).number_format="yyyy-mm-dd"
            ws.cell(row=r, column=3, value=v)
            r += 1
    autosize(ws, 1, 4)

# =========================
#  Sidebar estado
# =========================
def _probe(fn, ok_pred):
    t0 = time.perf_counter()
    status, msg = "err", ""
    try:
        res = fn()
        status = ok_pred(res)
        msg = "OK" if status=="ok" else ("Parcial" if status=="warn" else "Sin datos")
    except Exception as e:
        status, msg = "err", f"ExcepciÃ³n: {type(e).__name__}"
    ms = int((time.perf_counter()-t0)*1000)
    return status, msg, ms

def _render_sidebar_status():
    st.sidebar.header("ðŸ”Ž Estado de fuentes")
    st.sidebar.caption(f"Ãšltima verificaciÃ³n: {now_ts()}")
    b_status, b_msg, b_ms = _probe(lambda: sie_latest(SIE_SERIES["USD_FIX"]),
                                   lambda res: "ok" if isinstance(res, tuple) and res[0] and (res[1] is not None) else "err")
    i_status, i_msg, i_ms = _probe(lambda: get_uma(INEGI_TOKEN),
                                   lambda res: "ok" if isinstance(res, dict) and (res.get("diaria") is not None) else ("warn" if isinstance(res, dict) else "err"))
    if not FRED_TOKEN.strip():
        f_status, f_msg, f_ms = ("warn", "Sin token (fallback)", 0)
    else:
        f_status, f_msg, f_ms = _probe(lambda: fred_cpi_yoy_series(n=1),
                                       lambda res: "ok" if isinstance(res, list) else "warn")
    def badge(status, label, msg, ms):
        dot = "ðŸŸ¢" if status=="ok" else ("ðŸŸ¡" if status=="warn" else "ðŸ”´")
        st.sidebar.write(f"{dot} **{label}** â€” {msg} Â· {ms} ms")
    badge(b_status, "Banxico (SIE)", b_msg, b_ms)
    badge(i_status, "INEGI (UMA)", i_msg, i_ms)
    badge(f_status, "FRED (USA)", f_msg, f_ms)
    st.sidebar.divider()
    if st.sidebar.button("Revisar fuentes ahora"):
        st.rerun()

# =========================
#  UI
# =========================
st.set_page_config(page_title="Indicadores EconÃ³micos", page_icon="ðŸ“ˆ", layout="centered")
st.title("ðŸ“ˆ Indicadores (Ãºltimos 6 dÃ­as) + Noticias")
st.caption("Excel con tu layout + hoja de Noticias; opcional GrÃ¡ficos y Datos crudos.")

with st.expander("Opciones"):
    movex_win = st.number_input("Ventana MOVEX (dÃ­as hÃ¡biles)", min_value=5, max_value=60, value=20, step=1)
    margen_pct = st.number_input("Margen Compra/Venta sobre FIX (% por lado)", min_value=0.0, max_value=5.0, value=0.5, step=0.1)
    do_charts = st.toggle("Agregar hoja 'GrÃ¡ficos' (Ãºltimos 12)", value=True)
    do_raw    = st.toggle("Agregar hoja 'Datos crudos' (Ãºltimos 12)", value=True)

_check_tokens()
_render_sidebar_status()

if st.button("Generar Excel"):
    # â”€â”€ 1) Series Ãºltimos 6
    def pad6(lst): return ([None]*(6-len(lst)))+lst if len(lst)<6 else lst

    usd6  = pad6([v for _, v in sie_last_n(SIE_SERIES["USD_FIX"], n=6)])
    eur6  = pad6([v for _, v in sie_last_n(SIE_SERIES["EUR_FIX"], n=6)])
    jpy6  = pad6([v for _, v in sie_last_n(SIE_SERIES["JPY_FIX"], n=6)])
    udis6 = pad6([v for _, v in sie_last_n(SIE_SERIES["UDIS"],    n=6)])

    movex6  = rolling_movex_for_last6(window=int(movex_win))
    compra6 = [x*(1 - margen_pct/100.0) if x is not None else None for x in usd6]
    venta6  = [x*(1 + margen_pct/100.0) if x is not None else None for x in usd6]
    eurusd6 = [(e/u if (e is not None and u) else None) for e,u in zip(eur6, usd6)]
    usdjpy6 = [(u/j if (u is not None and j) else None) for u,j in zip(usd6, jpy6)]

    tiie28_6  = pad6([v for _, v in sie_last_n(SIE_SERIES["TIIE_28"], n=6)])
    cetes28_6 = pad6([v for _, v in sie_last_n(SIE_SERIES["CETES_28"], n=6)])

    none6 = [None]*6
    tiie_obj6  = none6 if not SIE_SERIES["TIIE_OBJ"]  else pad6([v for _, v in sie_last_n(SIE_SERIES["TIIE_OBJ"],  n=6)])
    tiie91_6   = none6 if not SIE_SERIES["TIIE_91"]   else pad6([v for _, v in sie_last_n(SIE_SERIES["TIIE_91"],   n=6)])
    tiie182_6  = none6 if not SIE_SERIES["TIIE_182"]  else pad6([v for _, v in sie_last_n(SIE_SERIES["TIIE_182"],  n=6)])
    cetes91_6  = none6 if not SIE_SERIES["CETES_91"]  else pad6([v for _, v in sie_last_n(SIE_SERIES["CETES_91"],  n=6)])
    cetes182_6 = none6 if not SIE_SERIES["CETES_182"] else pad6([v for _, v in sie_last_n(SIE_SERIES["CETES_182"], n=6)])
    cetes364_6 = none6 if not SIE_SERIES["CETES_364"] else pad6([v for _, v in sie_last_n(SIE_SERIES["CETES_364"], n=6)])

    uma = get_uma(INEGI_TOKEN)
    valores = {
        "usd6": usd6, "eur6": eur6, "jpy6": jpy6,
        "eurusd6": eurusd6, "usdjpy6": usdjpy6,
        "udis6": udis6,
        "tiie_obj6": tiie_obj6, "tiie28_6": tiie28_6, "tiie91_6": tiie91_6, "tiie182_6": tiie182_6,
        "cetes28_6": cetes28_6, "cetes91_6": cetes91_6, "cetes182_6": cetes182_6, "cetes364_6": cetes364_6,
        "uma_diaria6": [uma["diaria"]]*6, "uma_mensual6": [uma["mensual"]]*6, "uma_anual6": [uma["anual"]]*6,
    }

    # â”€â”€ 2) Noticias (con fallback)
    news = fetch_financial_news(limit_per_feed=8, total_limit=20)

    try:
        # Hoja Indicadores con tu layout
        wb = crear_hoja_indicadores_layout(valores, movex6, compra6, venta6)
        # Hoja Noticias
        add_news_sheet(wb, news)

        # â”€â”€ 3) Hojas opcionales
        if do_charts or do_raw:
            usd_last12  = sie_last_n(SIE_SERIES["USD_FIX"], n=12)
            tiie_last12 = sie_last_n(SIE_SERIES["TIIE_28"], n=12)
            fed_last12  = fred_last_n("FEDFUNDS", n=12)
            cpi_last12  = fred_cpi_yoy_series(n=12)

            if do_charts:
                ws3 = wb.create_sheet("GrÃ¡ficos")
                ws3['A1'] = "Series histÃ³ricas (Ãºltimos 12 datos)"; ws3['A1'].font = Font(bold=True)
                r_usd = write_series_table(ws3, 3, 1, "USD/MXN (FIX)", usd_last12)
                r_tii = write_series_table(ws3, 3, 4, "TIIE 28d (%)", tiie_last12)
                r_fed = write_series_table(ws3, 22,1, "Fed Funds (%)", fed_last12)
                r_cpi = write_series_table(ws3, 22,4, "InflaciÃ³n EUA YoY (%)", cpi_last12)
                add_line_chart(ws3, "USD/MXN - Ãšltimos 12", r_usd, ("H", 2))
                add_line_chart(ws3, "TIIE 28d - Ãšltimos 12", r_tii, ("H", 18))
                add_line_chart(ws3, "Fed Funds - Ãšltimos 12", r_fed, ("H", 34))
                add_line_chart(ws3, "InflaciÃ³n EUA YoY - Ãšltimos 12", r_cpi, ("H", 50))

            if do_raw:
                raw = {
                    "USD/MXN (FIX)": usd_last12,
                    "TIIE 28d (%)": tiie_last12,
                    "Fed Funds (%)": fed_last12,
                    "InflaciÃ³n EUA YoY (%)": cpi_last12,
                }
                add_raw_sheet(wb, raw)

        bio = io.BytesIO(); wb.save(bio)
        st.success("Â¡Listo! Archivo generado sin reparaciones de Excel.")
        st.download_button(
            "Descargar Excel",
            data=bio.getvalue(),
            file_name=f"indicadores_{today_cdmx()}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
    except Exception as e:
        st.error(f"OcurriÃ³ un error al generar el Excel: {e}")
