# -*- coding: utf-8 -*-
"""Untitled16.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/18xSjlYum0k2ndcM1f52KaFCunTC81E2U
"""

# app.py
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Streamlit app SIN archivo base, tokens en c√≥digo y Excel NUEVO con indicadores.
# Incluye: Banxico (SIE), INEGI (UMA), FRED (Fed Funds + US CPI YoY) y hoja "Gr√°ficos".
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# app.py
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Streamlit app SIN archivo base, tokens en c√≥digo y Excel NUEVO con indicadores.
# Incluye: Banxico (SIE), INEGI (UMA), FRED (Fed Funds + US CPI YoY),
# hoja "Gr√°ficos" y hoja "Datos crudos" para Power BI (toggle).
# Sidebar con "sem√°foros" (estado de fuentes + latencia).
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

import io
import time
from datetime import datetime, timedelta
import pytz
import requests
from requests.adapters import HTTPAdapter, Retry
import streamlit as st
from openpyxl import Workbook
from openpyxl.styles import Alignment, Font
from openpyxl.utils import get_column_letter
from openpyxl.chart import LineChart, Reference
from openpyxl.chart.axis import DateAxis

# =========================
#  TOKENS (repo privado)
# =========================
BANXICO_TOKEN = "677aaedf11d11712aa2ccf73da4d77b6b785474eaeb2e092f6bad31b29de6609"
INEGI_TOKEN   = "9886fe68-e51f-c345-0b8f-adb99da1a1fd"
FRED_TOKEN    = ""  # Opcional; si lo dejas vac√≠o, habr√° fallbacks

TZ_MX = pytz.timezone("America/Mexico_City")

# =========================
#  SERIES SIE DE BANXICO
# =========================
SIE_SERIES = {
    "USD_FIX":   "SF43718",   # Tipo de cambio FIX
    "EUR_FIX":   "SF46410",   # Euro
    "JPY_FIX":   "SF46406",   # Yen
    "TIIE_28":   "SF60653",   # TIIE 28 d√≠as
    "CETES_28":  "SF43936",   # CETES 28 d√≠as
    "UDIS":      "SP68257",   # UDIS
    # Si conoces la serie exacta de inflaci√≥n MX YoY, col√≥cala aqu√≠ (si no, usamos fallback).
    "MX_INFL_YOY": ""
}

# =========================
#  HTTP con reintentos
# =========================
def http_session(timeout=15):
    s = requests.Session()
    retries = Retry(
        total=3,
        backoff_factor=0.8,
        status_forcelist=[429, 500, 502, 503, 504],
        allowed_methods=frozenset(["GET", "POST"])
    )
    s.mount("https://", HTTPAdapter(max_retries=retries))
    s.request_timeout = timeout
    return s

def now_ts():
    return datetime.now(TZ_MX).strftime("%Y-%m-%d %H:%M:%S")

def today_cdmx():
    return datetime.now(TZ_MX).date()

def try_float(x):
    try:
        return float(str(x).replace(",", ""))
    except:
        return None

def is_empty(x: str) -> bool:
    return (x is None) or (str(x).strip() == "")

def _check_tokens():
    # Banxico e INEGI son requeridos; FRED es opcional.
    missing = []
    if not BANXICO_TOKEN.strip():
        missing.append("BANXICO_TOKEN")
    if not INEGI_TOKEN.strip():
        missing.append("INEGI_TOKEN")
    if missing:
        st.error("Configura los siguientes tokens antes de continuar: " + ", ".join(missing))
        st.stop()

# =========================
#  BANXICO SIE (√∫ltimo dato)
# =========================
@st.cache_data(ttl=60*30)
def sie_opportuno(series_id, banxico_token):
    url = f"https://www.banxico.org.mx/SieAPIRest/service/v1/series/{series_id}/datos/oportuno"
    headers = {"Bmx-Token": banxico_token}
    s = http_session()
    r = s.get(url, headers=headers, timeout=s.request_timeout)
    r.raise_for_status()
    return r.json()

def sie_latest(series_id):
    if is_empty(series_id):
        return None, None
    try:
        data = sie_opportuno(series_id, BANXICO_TOKEN)
        serie = data["bmx"]["series"][0]["datos"]
        if not serie:
            return None, None
        last = serie[-1]
        return last["fecha"], try_float(last["dato"])
    except:
        return None, None

# =========================
#  BANXICO SIE (hist√≥rico)
# =========================
@st.cache_data(ttl=60*30)
def sie_range(series_id: str, start_iso: str, end_iso: str):
    url = f"https://www.banxico.org.mx/SieAPIRest/service/v1/series/{series_id}/datos/{start_iso}/{end_iso}"
    headers = {"Bmx-Token": BANXICO_TOKEN}
    s = http_session(timeout=20)
    r = s.get(url, headers=headers, timeout=s.request_timeout)
    r.raise_for_status()
    j = r.json()
    series = j.get("bmx", {}).get("series", [])
    if not series:
        return []
    return series[0].get("datos", []) or []

def sie_last_n(series_id: str, n: int = 12):
    end = today_cdmx()
    start = end - timedelta(days=365*2)
    obs = sie_range(series_id, start.isoformat(), end.isoformat())
    vals = []
    for o in obs:
        f = o.get("fecha")
        v = try_float(o.get("dato"))
        if f and (v is not None):
            vals.append((f, v))
    if not vals:
        return []
    return vals[-n:]

# =========================
#  INEGI (UMA) ‚Äì robusto
# =========================
@st.cache_data(ttl=60*60)
def get_uma(inegi_token: str):
    """
    UMA desde INEGI (nacional):
    - Indicadores: 620706 (diaria), 620707 (mensual), 620708 (anual)
    - √Årea geogr√°fica: '00'
    - Dato m√°s reciente: 'true'
    """
    base = "https://www.inegi.org.mx/app/api/indicadores/desarrolladores/jsonxml/INDICATOR"
    ids = "620706,620707,620708"
    url = f"{base}/{ids}/es/00/true/BISE/2.0/{inegi_token}?type=json"

    s = http_session(timeout=20)
    try:
        r = s.get(url, timeout=s.request_timeout)
        status = r.status_code
        if status == 401 or status == 403:
            st.warning("INEGI UMA: autenticaci√≥n/autorizaci√≥n fallida (401/403). Usando fallback.")
            return {"fecha": str(today_cdmx()), "diaria": None, "mensual": None, "anual": None}
        if status != 200:
            st.warning(f"INEGI UMA: respuesta HTTP {status}. Usando fallback.")
            return {"fecha": str(today_cdmx()), "diaria": None, "mensual": None, "anual": None}

        data = r.json()
        series = data.get("Series", [])
        if not series or any("OBSERVATIONS" not in s for s in series):
            st.warning("INEGI UMA: respuesta sin 'Series/OBSERVATIONS'. Usando fallback.")
            return {"fecha": str(today_cdmx()), "diaria": None, "mensual": None, "anual": None}

        diaria_obs  = series[0]["OBSERVATIONS"][-1]
        mensual_obs = series[1]["OBSERVATIONS"][-1] if series[1]["OBSERVATIONS"] else None
        anual_obs   = series[2]["OBSERVATIONS"][-1] if series[2]["OBSERVATIONS"] else None

        fecha   = diaria_obs.get("TIME_PERIOD") or str(today_cdmx())
        diaria  = try_float(diaria_obs.get("OBS_VALUE"))
        mensual = try_float(mensual_obs.get("OBS_VALUE")) if mensual_obs else None
        anual   = try_float(anual_obs.get("OBS_VALUE")) if anual_obs else None

        # Derivar si faltan mensual/anual
        if diaria is not None:
            if mensual is None:
                mensual = diaria * 30.4
            if anual is None and mensual is not None:
                anual = mensual * 12

        return {"fecha": fecha, "diaria": diaria, "mensual": mensual, "anual": anual}

    except Exception as e:
        st.warning(f"INEGI UMA: error {type(e).__name__}. Usando fallback.")
        return {"fecha": str(today_cdmx()), "diaria": None, "mensual": None, "anual": None}

# =========================
#  FRED (Fed Funds + CPI YoY) ‚Äì opcional
# =========================
@st.cache_data(ttl=60*30)
def fred_observations(series_id: str, start_date: str = None, end_date: str = None):
    base = "https://api.stlouisfed.org/fred/series/observations"
    params = {"series_id": series_id, "file_type": "json"}
    if FRED_TOKEN.strip():
        params["api_key"] = FRED_TOKEN.strip()
    if start_date:
        params["observation_start"] = start_date
    if end_date:
        params["observation_end"] = end_date
    s = http_session(timeout=20)
    r = s.get(base, params=params, timeout=s.request_timeout)
    r.raise_for_status()
    j = r.json()
    return j.get("observations", [])

def fred_latest_value(series_id: str):
    try:
        end = datetime.utcnow().date()
        start = (end - timedelta(days=3*365)).isoformat()
        obs = fred_observations(series_id, start_date=start, end_date=end.isoformat())
        obs = [o for o in obs if o.get("value") not in (".", None)]
        if not obs:
            return None, None
        last = obs[-1]
        return last["date"], try_float(last["value"])
    except:
        return None, None

def fred_last_n(series_id: str, n: int = 12):
    try:
        end = datetime.utcnow().date()
        start = (end - timedelta(days=5*365)).isoformat()
        obs = fred_observations(series_id, start_date=start, end_date=end.isoformat())
        out = []
        for o in obs:
            v = o.get("value")
            if v not in (".", None):
                out.append((o.get("date"), try_float(v)))
        if not out:
            return []
        return out[-n:]
    except:
        return []

def fred_cpi_yoy_series(n: int = 12):
    """
    Serie YoY % de CPIAUCSL: (CPI(t)/CPI(t-12) - 1) * 100, √∫ltimos n meses.
    """
    try:
        end = datetime.utcnow().date()
        start = (end - timedelta(days=6*365)).isoformat()
        obs = fred_observations("CPIAUCSL", start_date=start, end_date=end.isoformat())
        obs = [(o["date"], try_float(o["value"])) for o in obs if o.get("value") not in (".", None)]
        if len(obs) < 13:
            return []
        yoy = []
        for i in range(12, len(obs)):
            f_now, v_now = obs[i]
            f_prev, v_prev = obs[i-12]
            if v_now is None or v_prev in (None, 0):
                continue
            yoy.append((f_now, (v_now / v_prev - 1.0) * 100.0))
        if not yoy:
            return []
        return yoy[-n:]
    except:
        return []

def get_us_from_fred():
    fed_date, fed_val = fred_latest_value("FEDFUNDS")
    yoy_series = fred_cpi_yoy_series(n=1)
    cpi_date, cpi_yoy = (yoy_series[-1] if yoy_series else (None, None))
    # Fallbacks
    if fed_val is None:
        fed_date, fed_val = str(today_cdmx()), 5.50
    if cpi_yoy is None:
        cpi_date, cpi_yoy = str(today_cdmx()), 3.20
    return {"FEDFUNDS": (fed_date, fed_val), "US_CPI_YoY": (cpi_date, cpi_yoy)}

# =========================
#  Consolidadores (√∫ltimo dato)
# =========================
def get_fx_from_sie():
    usd = sie_latest(SIE_SERIES["USD_FIX"]) or (None, None)
    eur = sie_latest(SIE_SERIES["EUR_FIX"]) or (None, None)
    jpy = sie_latest(SIE_SERIES["JPY_FIX"]) or (None, None)
    if usd == (None, None): usd = (str(today_cdmx()), 18.50)
    if eur == (None, None): eur = (str(today_cdmx()), 20.10)
    if jpy == (None, None): jpy = (str(today_cdmx()), 0.128)
    return {"USD": usd, "EUR": eur, "JPY": jpy}

def get_tiie_cetes_from_sie():
    tiie = sie_latest(SIE_SERIES["TIIE_28"]) or (None, None)
    cetes = sie_latest(SIE_SERIES["CETES_28"]) or (None, None)
    if tiie == (None, None): tiie = (str(today_cdmx()), 11.30)
    if cetes == (None, None): cetes = (str(today_cdmx()), 10.75)
    return {"TIIE_28": tiie, "CETES_28": cetes}

def get_udis_from_sie():
    udis = sie_latest(SIE_SERIES["UDIS"]) or (None, None)
    if udis == (None, None): udis = (str(today_cdmx()), 8.15)
    return udis

def get_inflacion_mx_yoy_from_sie():
    infl = sie_latest(SIE_SERIES["MX_INFL_YOY"]) or (None, None)
    if infl == (None, None): infl = (str(today_cdmx()), 4.47)
    return infl

# =========================
#  EXCEL helpers
# =========================
def set_cell(ws, cell, value, bold=False, numfmt=None, wrap=False):
    ws[cell].value = value
    if bold:
        ws[cell].font = Font(bold=True)
    if numfmt:
        ws[cell].number_format = numfmt
    if wrap:
        ws[cell].alignment = Alignment(wrap_text=True, vertical="top")

def autosize(ws, min_col=1, max_col=10):
    for col in range(min_col, max_col+1):
        letter = get_column_letter(col)
        max_len = 0
        for cell in ws[letter]:
            v = cell.value
            if v is None:
                continue
            max_len = max(max_len, len(str(v)))
        ws.column_dimensions[letter].width = min(max_len + 2, 60)

# -------------------------
# Hoja "Gr√°ficos" (helpers)
# -------------------------
def write_series_table(ws, start_row: int, start_col: int, title: str, series):
    r = start_row
    c = start_col
    ws.cell(row=r, column=c, value=title).font = Font(bold=True)
    r += 1
    ws.cell(row=r, column=c, value="Fecha").font = Font(bold=True)
    ws.cell(row=r, column=c+1, value="Valor").font = Font(bold=True)
    r += 1
    for (f, v) in series:
        ws.cell(row=r, column=c, value=f)
        ws.cell(row=r, column=c+1, value=v)
        r += 1
    data_start_row = start_row + 2
    data_end_row = r - 1
    return (data_start_row, c, data_end_row, c+1)

def add_line_chart(ws, title: str, data_range, cat_is_dates=True, place_at=("H", 2)):
    (r0, c0, r1, c1) = data_range
    chart = LineChart()
    chart.title = title
    chart.style = 2
    chart.y_axis.title = "Valor"
    if cat_is_dates:
        chart.x_axis = DateAxis()
        chart.x_axis.number_format = "yyyy-mm-dd"
        chart.x_axis.title = "Fecha"
    data = Reference(ws, min_col=c1, min_row=r0, max_col=c1, max_row=r1)
    cats = Reference(ws, min_col=c0, min_row=r0, max_row=r1)
    chart.add_data(data, titles_from_data=False)
    chart.set_categories(cats)
    anchor_col, anchor_row = place_at
    ws.add_chart(chart, f"{anchor_col}{anchor_row}")

# -------------------------
# Hoja "Datos crudos" (helper)
# -------------------------
def add_raw_data_sheet(wb, raw_data: dict):
    """
    raw_data: dict con listas de (fecha_str, valor_float). Claves esperadas:
      USD_LAST12, TIIE_LAST12, FEDFUNDS_LAST12, US_CPI_YOY_LAST12
    Se escribe en formato "largo": Serie | Fecha | Valor (ideal para Power BI).
    """
    ws = wb.create_sheet("Datos crudos")
    set_cell(ws, "A1", "Datos crudos (√∫ltimos 12 datos por serie)", bold=True)
    # Encabezados
    ws.cell(row=3, column=1, value="Serie").font = Font(bold=True)
    ws.cell(row=3, column=2, value="Fecha").font = Font(bold=True)
    ws.cell(row=3, column=3, value="Valor").font = Font(bold=True)

    mapping = [
        ("USD/MXN (FIX)",          raw_data.get("USD_LAST12", [])),
        ("TIIE 28d (%)",           raw_data.get("TIIE_LAST12", [])),
        ("Fed Funds (%)",          raw_data.get("FEDFUNDS_LAST12", [])),
        ("Inflaci√≥n EUA YoY (%)",  raw_data.get("US_CPI_YOY_LAST12", [])),
    ]
    r = 4
    for serie_nombre, serie_vals in mapping:
        for (fecha, valor) in serie_vals:
            ws.cell(row=r, column=1, value=serie_nombre)
            ws.cell(row=r, column=2, value=fecha)   # Deja la fecha como texto; Power BI la parsea f√°cil
            ws.cell(row=r, column=3, value=valor)
            r += 1

    autosize(ws, 1, 6)

# -------------------------
# Construcci√≥n del Excel completo
# -------------------------
def crear_excel(datos: dict, graficos_data: dict | None = None, raw_data: dict | None = None) -> bytes:
    wb = Workbook()
    ws = wb.active
    ws.title = "Indicadores"

    set_cell(ws, "A1", "Actualizaci√≥n de Indicadores", bold=True)
    set_cell(ws, "A2", f"Generado: {now_ts()} (CDMX)")

    rows = [
        ("Indicador", "Fecha", "Valor", "Unidad / Nota"),
        ("USD/MXN",           datos["fx"]["USD"][0],              datos["fx"]["USD"][1],              ""),
        ("EUR/MXN",           datos["fx"]["EUR"][0],              datos["fx"]["EUR"][1],              ""),
        ("JPY/MXN",           datos["fx"]["JPY"][0],              datos["fx"]["JPY"][1],              ""),
        ("TIIE 28d (%)",      datos["tiie_cetes"]["TIIE_28"][0],  datos["tiie_cetes"]["TIIE_28"][1],  ""),
        ("CETES 28d (%)",     datos["tiie_cetes"]["CETES_28"][0], datos["tiie_cetes"]["CETES_28"][1], ""),
        ("UDIS",              datos["udis"][0],                   datos["udis"][1],                   ""),
        ("Inflaci√≥n MX YoY (%)", datos["infl_mx"][0],             datos["infl_mx"][1],                ""),
        ("Fed Funds (%)",     datos["us"]["FEDFUNDS"][0],         datos["us"]["FEDFUNDS"][1],         ""),
        ("Inflaci√≥n EUA YoY (%)", datos["us"]["US_CPI_YoY"][0],   datos["us"]["US_CPI_YoY"][1],       ""),
        ("UMA diaria",        datos["uma"]["fecha"],              datos["uma"]["diaria"],             ""),
        ("UMA mensual",       datos["uma"]["fecha"],              datos["uma"]["mensual"],            ""),
        ("UMA anual",         datos["uma"]["fecha"],              datos["uma"]["anual"],              ""),
    ]

    start_row = 5
    for j, v in enumerate(rows[0], start=1):
        cell = ws.cell(row=start_row, column=j, value=v)
        cell.font = Font(bold=True)
    for i, r in enumerate(rows[1:], start=start_row + 1):
        for j, v in enumerate(r, start=1):
            ws.cell(row=i, column=j, value=v)

    autosize(ws, 1, 6)

    # Hoja "Noticias"
    ws2 = wb.create_sheet("Noticias")
    set_cell(ws2, "A1", "Eventos relevantes (pr√≥ximos 5 meses)", bold=True)
    set_cell(ws2, "A3", "Notas del analista:", bold=True)
    set_cell(ws2, "A5",
             "- Banxico / Fed (decisiones y forward guidance)\n"
             "- Inflaci√≥n y empleo (MX/EUA)\n"
             "- Precios de materias primas (resina, fibra, combustibles)\n"
             "- Tipo de cambio y volatilidad regional",
             wrap=True)
    autosize(ws2, 1, 4)

    # Hoja "Gr√°ficos"
    if graficos_data:
        ws3 = wb.create_sheet("Gr√°ficos")
        set_cell(ws3, "A1", "Series hist√≥ricas (√∫ltimos 12 datos)", bold=True)

        # 1) USD/MXN
        usd_range = write_series_table(ws3, start_row=3, start_col=1, title="USD/MXN (FIX)", series=graficos_data["USD_LAST12"])
        add_line_chart(ws3, "USD/MXN - √öltimos 12", usd_range, place_at=("H", 2))

        # 2) TIIE 28 d√≠as
        tiie_range = write_series_table(ws3, start_row=3, start_col=4, title="TIIE 28d (%)", series=graficos_data["TIIE_LAST12"])
        add_line_chart(ws3, "TIIE 28d - √öltimos 12", tiie_range, place_at=("H", 18))

        # 3) Fed Funds
        fed_range = write_series_table(ws3, start_row=22, start_col=1, title="Fed Funds (%)", series=graficos_data["FEDFUNDS_LAST12"])
        add_line_chart(ws3, "Fed Funds - √öltimos 12", fed_range, place_at=("H", 34))

        # 4) Inflaci√≥n EUA YoY
        cpiyoy_range = write_series_table(ws3, start_row=22, start_col=4, title="Inflaci√≥n EUA YoY (%)", series=graficos_data["US_CPI_YOY_LAST12"])
        add_line_chart(ws3, "Inflaci√≥n EUA YoY - √öltimos 12", cpiyoy_range, place_at=("H", 50))

        autosize(ws3, 1, 12)

    # Hoja "Datos crudos"
    if raw_data:
        add_raw_data_sheet(wb, raw_data)

    bio = io.BytesIO()
    wb.save(bio)
    return bio.getvalue()

# =========================
#  Sidebar "Sem√°foros" de fuentes
# =========================
def _probe(fn, ok_pred, name: str):
    t0 = time.perf_counter()
    status = "err"
    msg = ""
    try:
        res = fn()
        status = ok_pred(res)
        msg = "OK" if status == "ok" else ("Parcial" if status == "warn" else "Sin datos")
    except Exception as e:
        status = "err"
        msg = f"Excepci√≥n: {type(e).__name__}"
    ms = int((time.perf_counter() - t0) * 1000)
    return status, msg, ms

def _render_sidebar_status():
    st.sidebar.header("üîé Estado de fuentes")
    st.sidebar.caption(f"√öltima verificaci√≥n: {now_ts()}")

    # Banxico
    def _banxico_fn():
        return sie_latest(SIE_SERIES["USD_FIX"])
    def _banxico_pred(res):
        f, v = res if isinstance(res, tuple) else (None, None)
        if f and (v is not None):
            return "ok"
        return "err"
    b_status, b_msg, b_ms = _probe(_banxico_fn, _banxico_pred, "Banxico")

    # INEGI
    def _inegi_fn():
        return get_uma(INEGI_TOKEN)
    def _inegi_pred(res):
        if not isinstance(res, dict):
            return "err"
        if res.get("diaria") is None:
            return "warn"  # tenemos fecha pero sin valor -> parcial
        return "ok"
    i_status, i_msg, i_ms = _probe(_inegi_fn, _inegi_pred, "INEGI")

    # FRED (opcional)
    if not FRED_TOKEN.strip():
        f_status, f_msg, f_ms = ("warn", "Sin token (usando fallback)", 0)
    else:
        def _fred_fn():
            return get_us_from_fred()
        def _fred_pred(res):
            try:
                fed = res.get("FEDFUNDS", (None, None))[1]
                cpi = res.get("US_CPI_YoY", (None, None))[1]
                if fed is not None and cpi is not None:
                    return "ok"
                return "warn"
            except:
                return "err"
        f_status, f_msg, f_ms = _probe(_fred_fn, _fred_pred, "FRED")

    def badge(status, label, msg, ms):
        dot = "üü¢" if status == "ok" else ("üü°" if status == "warn" else "üî¥")
        st.sidebar.write(f"{dot} **{label}** ‚Äî {msg} ¬∑ {ms} ms")

    badge(b_status, "Banxico (SIE)", b_msg, b_ms)
    badge(i_status, "INEGI (UMA)", i_msg, i_ms)
    badge(f_status, "FRED (USA)", f_msg, f_ms)

    st.sidebar.divider()
    if st.sidebar.button("Revisar fuentes ahora"):
        st.rerun()

# =========================
#  STREAMLIT UI
# =========================
st.set_page_config(page_title="Indicadores Econ√≥micos", page_icon="üìà", layout="centered")
st.title("üìà Actualizaci√≥n de Indicadores (Autom√°tica)")
st.caption("Genera un Excel nuevo con datos de Banxico, INEGI y (opcional) FRED. Incluye hojas de Gr√°ficos y Datos crudos. No requiere archivo base.")

with st.expander("Opciones (activa/desactiva)"):
    do_fx = st.toggle("Tipos de cambio (USD, EUR, JPY)", value=True)
    do_tiie = st.toggle("TIIE y CETES (28d)", value=True)
    do_udis = st.toggle("UDIS", value=True)
    do_uma = st.toggle("UMA (diaria, mensual, anual)", value=True)
    do_mx_infl = st.toggle("Inflaci√≥n M√©xico (YoY)", value=True)
    do_us = st.toggle("EUA: Fed Funds / Inflaci√≥n YoY (FRED)", value=True)
    do_charts = st.toggle("Incluir hoja de Gr√°ficos (√∫ltimos 12 datos)", value=True)
    do_raw = st.toggle("Exportar hoja 'Datos crudos' (√∫ltimos 12 datos)", value=True)

_check_tokens()
_render_sidebar_status()

if st.button("Generar Excel nuevo"):
    # √öltimos datos (tabla principal)
    fx = get_fx_from_sie() if do_fx else {"USD": (None, None), "EUR": (None, None), "JPY": (None, None)}
    tiie_cetes = get_tiie_cetes_from_sie() if do_tiie else {"TIIE_28": (None, None), "CETES_28": (None, None)}
    udis = get_udis_from_sie() if do_udis else (None, None)
    uma = get_uma(INEGI_TOKEN) if do_uma else {"fecha": None, "diaria": None, "mensual": None, "anual": None}
    infl_mx = get_inflacion_mx_yoy_from_sie() if do_mx_infl else (None, None)
    us = get_us_from_fred() if do_us else {"FEDFUNDS": (None, None), "US_CPI_YoY": (None, None)}

    datos = {"fx": fx, "tiie_cetes": tiie_cetes, "udis": udis, "uma": uma, "infl_mx": infl_mx, "us": us}

    # Hist√≥ricos (para gr√°ficos y/o datos crudos)
    graficos_data = None
    raw_data = None
    if do_charts or do_raw:
        try:
            usd_last12 = sie_last_n(SIE_SERIES["USD_FIX"], n=12) if do_fx else []
            tiie_last12 = sie_last_n(SIE_SERIES["TIIE_28"], n=12) if do_tiie else []
            fed_last12 = fred_last_n("FEDFUNDS", n=12) if do_us else []
            cpiyoy_last12 = fred_cpi_yoy_series(n=12) if do_us else []
            # Fallbacks suaves para no dejar hojas vac√≠as
            if not usd_last12:     usd_last12 = [(str(today_cdmx()), 18.5)]
            if not tiie_last12:    tiie_last12 = [(str(today_cdmx()), 11.3)]
            if not fed_last12:     fed_last12 = [(str(today_cdmx()), 5.5)]
            if not cpiyoy_last12:  cpiyoy_last12 = [(str(today_cdmx()), 3.2)]

            graficos_data = {
                "USD_LAST12": usd_last12,
                "TIIE_LAST12": tiie_last12,
                "FEDFUNDS_LAST12": fed_last12,
                "US_CPI_YOY_LAST12": cpiyoy_last12,
            }
            raw_data = graficos_data if do_raw else None
        except Exception as e:
            st.warning(f"No se pudieron preparar series hist√≥ricas: {e}")
            graficos_data = None
            raw_data = None

    try:
        xlsx = crear_excel(datos, graficos_data=graficos_data if do_charts else None, raw_data=raw_data)
        st.success("¬°Listo! Archivo generado correctamente.")
        st.download_button(
            "Descargar Excel de Indicadores",
            data=xlsx,
            file_name=f"indicadores_{today_cdmx()}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
    except Exception as e:
        st.error(f"Ocurri√≥ un error al generar el Excel: {e}")

st.info(
    "Si haces p√∫blico el repo, mueve BANXICO_TOKEN / INEGI_TOKEN / FRED_TOKEN a `st.secrets`.\n"
    "Si conoces el ID SIE de Inflaci√≥n MX YoY, col√≥calo en `SIE_SERIES['MX_INFL_YOY']`."
)
